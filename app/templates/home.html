{% extends "base.html" %}

{% block body %}
{% if current_user.is_authenticated %} <!-- If user is logged in -->
<h1>Discover More (Powered by: <span class="rainbow">Ollama</span>)</h1>
    <div id="chat-box">
        <h2>Meche Bot</h2>
        <form method="POST" id="chat-form">
            {{ form.hidden_tag() }}
            {{ form.message.label }}{{ form.message() }}
            {{ form.send() }}
        </form>
        <div id="chat-messages">
            <!-- Existing messages should appear here -->
            {% for message in messages %}
            <p>{{ message.username }}: {{ message.message }}</p>
            {% endfor %}
        </div>
    </div>

    <!-- Include jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> 

    <!-- Include Socket.IO JavaScript client from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>

    <!-- Chat-related JavaScript comes after -->
    <script>
        $(document).ready(function() {
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    var chatForm = $('#chat-form');
    var chatBox = $('#chat-messages');
    var messageInput = $('input[name="message"]');

    let lastSentMessage = "";

    chatForm.on('submit', function(e) {
        e.preventDefault();
        var msg = messageInput.val().trim();

        // Prevent empty or duplicate messages
        if (msg === "" || msg === lastSentMessage) {
            return false;
        }

        lastSentMessage = msg;
        socket.emit('message', msg);

        $.ajax({
            url: "{{ url_for('get_ai_response') }}",
            method: "POST",
            contentType: 'application/json;charset=UTF-8',
            data: JSON.stringify({message: msg}),
            headers: {
                'X-CSRFToken': "{{ csrf_token() }}"
            },
            success: function(data) {
                if (data.error) {
                    console.log('AI responded with error:', data.error);
                } else {
                    var newAIMessage = $('<p>').text('AI: ' + data.ai_response);
                    chatBox.append(newAIMessage);
                    chatBox.scrollTop(chatBox[0].scrollHeight);
                }
            }
        });

        messageInput.val('');
        return false;
    });

    // Show messages received
    socket.on('message', function(msg) {
        var newMessage = $('<p>').text(msg.username + " (" + msg.timestamp + "): " + msg.message);
        chatBox.append(newMessage);
        chatBox.scrollTop(chatBox[0].scrollHeight);
    });
});
    </script>

{% else %} <!-- If user is not yet logged in -->
    <h1>Welcome to OpenOcean.ai</h1>
    <p><a class="purple-text-links" href="{{ url_for('login') }}">Log in</a> to get started, no account? It takes less than 5 minutes to <a class="purple-text-links" href="{{ url_for('register') }}">Sign up</a>!</p>
    
    <!-- Feature Highlights Section -->
    <section class="features-highlight">
        <h2 class="centered">Explore the Features</h2>
        <div class="features-grid">
            <div class="feature">
                <img src="{{ url_for('static', filename='images/chat_feature.png') }}" alt="Chat Feature">
                <h3 class="centered">Interactive Chat</h3>
                <p>Engage in real-time conversations with the Meche Bot and explore dynamic responses powered by Ollama.</p>
            </div>
            <div class="feature">
                <img src="{{ url_for('static', filename='images/personality_test_feature.png') }}" alt="Personality Test Feature">
                <h3 class="centered">Personality Tests</h3>
                <p>Take personalized tests to understand your personality traits and receive insightful analysis.</p>
            </div>
        </div>
        <p class="centered">Join us and start exploring today!</p>
    </section>
{% endif %}
{% endblock %}