{% extends "base.html" %}

{% block body %}
{% if current_user.is_authenticated %} <!-- If user is logged in -->
<h1>Discover More (Powered by: Ollama)</h1>
    <div id="chat-box">
        <h2>Chat</h2>
        <form method="POST" id="chat-form">
            {{ form.hidden_tag() }}
            {{ form.message.label }}{{ form.message() }}
            {{ form.send() }}
        </form>
        <div id="chat-messages">
            <!-- Existing messages should appear here -->
            {% for message in messages %}
            <p>{{ message.username }}: {{ message.message }}</p>
            {% endfor %}
        </div>
    </div>

    <!-- Include jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> 

    <!-- Include Socket.IO JavaScript client from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>

    <!-- Your chat-related JavaScript comes after -->
    <script>
        $(document).ready(function() {
            var socket = io.connect('http://' + document.domain + ':' + location.port);
            var chatForm = $('#chat-form');
            var chatBox = $('#chat-messages');
            var messageInput = $('input[name="message"]');
    
            // Submit handler for the form
            chatForm.on('submit', function(e) {
                e.preventDefault();
                var msg = messageInput.val();
                socket.emit('message', msg);
    
                // Make AJAX request to get_aI_response along with the message
                $.ajax({
                    url: "{{ url_for('get_ai_response') }}",
                    method: "POST",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify({message: msg}), // convert the data to JSON format
                    headers:{
                        'X-CSRFToken': "{{ csrf_token() }}" // add this token for non-GET requests
                    },
                    success: function(data) {
                        if (data.error) {
                            console.log('AI responded with error:', data.error);
                        } else {
                            // Receive AI response and append to the chat box
                            var newAIMessage = $('<p>').text('AI: ' + data.ai_response);
                            chatBox.append(newAIMessage);
                            chatBox.scrollTop(chatBox[0].scrollHeight);
                        }
                    }
                });
    
                messageInput.val('');
                return false;
            });
            // Show messages received
            socket.on('message', function(msg) {
                var newMessage = $('<p>').text(msg.username + " (" + msg.timestamp + "): " + msg.message);
                chatBox.append(newMessage);
                chatBox.scrollTop(chatBox[0].scrollHeight);
            });
        });
    </script>

{% else %} <!-- If user is not yet logged in -->
    <h1>Welcome to OpenOcean.ai</h1>
    <p><a href="{{ url_for('login') }}">Log in</a> to get started, no account? It takes just 5 minutes to <a href="{{ url_for('register') }}">Register</a>!</p>
{% endif %}
{% endblock %}